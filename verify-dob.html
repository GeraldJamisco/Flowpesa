<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flowpesa â€” Date of birth</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<main class="dob-screen">
  <!-- Top bar -->
  <header class="top-bar">
    <div class="top">
      <button class="back-btn" type="button" onclick="history.back()" aria-label="Go back">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18L9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h1 class="top-title"></h1>
      <span class="top-ghost" aria-hidden="true"></span>
    </div>
  </header>

  <!-- Content -->
  <section class="content">
    <h2 class="heading">Date of birth</h2>
    <p class="subheading">Please enter your date of birth accurately.</p>

    <form id="dob-form" novalidate>
      <div class="row-head">
        <span>Month</span><span>Day</span><span>Year</span>
      </div>

      <div class="row-inputs">
        <input id="mm" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2" placeholder="MM" aria-label="Month">
        <input id="dd" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2" placeholder="DD" aria-label="Day">
        <input id="yy" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="YYYY" aria-label="Year">
      </div>

      <p class="error" id="dob-error" role="alert" hidden></p>

      <button id="dob-continue" class="cta" type="submit" disabled>
        Continue
      </button>
    </form>
  </section>
</main>

<script>
(() => {
  const mm = document.getElementById('mm');
  const dd = document.getElementById('dd');
  const yy = document.getElementById('yy');
  const btn = document.getElementById('dob-continue');
  const err = document.getElementById('dob-error');
  const form = document.getElementById('dob-form');

  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

  function autoAdvance(inp, maxLen, next) {
    inp.addEventListener('input', e => {
      e.target.value = e.target.value.replace(/\D/g,'').slice(0, maxLen);
      if (e.target.value.length === maxLen && next) next.focus();
      validate();
    });
    // backspace and jump back
    inp.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && !inp.value) {
        const prev = inp.previousElementSibling;
        if (prev) prev.focus();
      }
    });
  }

  autoAdvance(mm, 2, dd);
  autoAdvance(dd, 2, yy);
  autoAdvance(yy, 4, null);

  function validDate(y, m, d) {
    const dt = new Date(y, m - 1, d);
    return (
      dt.getFullYear() === y &&
      dt.getMonth() === m - 1 &&
      dt.getDate() === d
    );
  }

  function validate() {
    err.hidden = true;

    const m = Number(mm.value);
    const d = Number(dd.value);
    const y = Number(yy.value);

    // Basic presence
    const filled = mm.value.length === 2 && dd.value.length === 2 && yy.value.length === 4;
    if (!filled) {
      btn.disabled = true;
      btn.classList.remove('is-active');
      return;
    }

    // Quick range guards
    if (m < 1 || m > 12) return show('Invalid month.');
    if (y < 1900 || y > new Date().getFullYear()) return show('Invalid year.');

    // Clamp day by month/year (leap years handled by Date)
    if (!validDate(y, m, d)) return show('Invalid day for that month.');

    // Optional: minimum age (uncomment to enforce 18+)
    // const today = new Date();
    // const min = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
    // if (new Date(y, m-1, d) > min) return show('You must be at least 18 years old.');

    btn.disabled = false;
    btn.classList.add('is-active');
  }

  function show(message){
    err.textContent = message;
    err.hidden = false;
    btn.disabled = true;
    btn.classList.remove('is-active');
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    validate();
    if (btn.disabled) return;

    // Zero-pad month/day
    const dob = `${mm.value.padStart(2,'0')}-${dd.value.padStart(2,'0')}-${yy.value}`;
    // TODO: POST to backend then go next
    // await fetch('/api/kyc/dob', {...})
    location.href = 'verify-location.html'; // next step
  });

  // Initial state
  validate();
})();
</script>

</body>
</html>
